# AI æ¨¡å—æ¶æ„æ–‡æ¡£

**ç›®å½•**: `backend/app/ai/`  
**æ›´æ–°æ—¶é—´**: 2025-10-07

---

## ğŸ“‚ ç›®å½•ç»“æ„

```
backend/app/ai/
â”œâ”€â”€ adk_agent_adapter.py       # ADK Agent ä¸»é€‚é…å™¨ï¼ˆæ ¸å¿ƒå…¥å£ï¼‰
â”œâ”€â”€ adk_llm_adapter.py          # LLM å®¢æˆ·ç«¯é€‚é…å™¨
â”œâ”€â”€ adk_session_service.py      # ADK ä¼šè¯æœåŠ¡
â”œâ”€â”€ frontend_event_adapter.py   # å‰ç«¯äº‹ä»¶æ ¼å¼è½¬æ¢ï¼ˆADK â†’ å‰ç«¯å±•ç¤ºï¼‰
â”œâ”€â”€ mcp_tools_adapter.py        # MCP â†’ ADK å·¥å…·é€‚é…
â”œâ”€â”€ factory.py                  # AI å®¢æˆ·ç«¯å·¥å‚
â”‚
â”œâ”€â”€ mcp/                        # çœŸæ­£çš„ MCP åè®®å®ç°
â”‚   â”œâ”€â”€ protocol.py            # MCP åè®®å®šä¹‰ï¼ˆJSON-RPCï¼‰
â”‚   â”œâ”€â”€ server.py              # MCP Server åŸºç±»
â”‚   â”œâ”€â”€ client.py              # MCP Client å®ç°
â”‚   â””â”€â”€ tools_server.py        # å…·ä½“å·¥å…·æœåŠ¡å™¨
â”‚
â”œâ”€â”€ clients/                    # LLM å®¢æˆ·ç«¯å®ç°
â”‚   â”œâ”€â”€ base.py                # å®¢æˆ·ç«¯åŸºç±»
â”‚   â””â”€â”€ qwen_client.py         # Qwen/Ollama å®¢æˆ·ç«¯
â”‚
â””â”€â”€ tools/                      # å·¥å…·å®ç°
    â”œâ”€â”€ base.py                # å·¥å…·åŸºç±»
    â””â”€â”€ general/               # é€šç”¨å·¥å…·ï¼ˆè®¡ç®—å™¨ã€å¤©æ°”ã€æœç´¢ï¼‰
```

---

## ğŸ¯ æ ¸å¿ƒæ–‡ä»¶è¯´æ˜

### 1. **`adk_agent_adapter.py`** - ä¸»å…¥å£ â­â­â­â­â­

**è§’è‰²**: æ•´ä¸ª AI ç³»ç»Ÿçš„æ ¸å¿ƒé€‚é…å™¨

**ä¸»è¦åŠŸèƒ½**:
- ä½œä¸º ChatService å’Œ ADK Agent ä¹‹é—´çš„æ¡¥æ¢
- ç®¡ç†å®Œæ•´çš„å¯¹è¯æµç¨‹ï¼ˆåŒ…æ‹¬å¤šè½®å·¥å…·è°ƒç”¨ï¼‰
- é€šè¿‡ MCP åŠ¨æ€åŠ è½½å·¥å…·
- è½¬æ¢äº‹ä»¶æ ¼å¼ä¾›å‰ç«¯å±•ç¤º

**å…³é”®ç±»**:
```python
class ADKAgentAdapter:
    async def run_streaming(
        messages,      # å¯¹è¯å†å²
        system_prompt, # ç³»ç»Ÿæç¤º
        user_id,       # ç”¨æˆ·ID
        session_id     # ä¼šè¯ID
    ) -> AsyncIterator[Dict]:
        # è¿”å›æµå¼äº‹ä»¶
```

**è°ƒç”¨è€…**: `ChatService`  
**ä¾èµ–**:
- `ADKLlmAdapter` - LLM é€šä¿¡
- `SimpleSessionService` - ä¼šè¯ç®¡ç†
- `FrontendEventAdapter` - å‰ç«¯æ ¼å¼è½¬æ¢
- `mcp_tools_adapter` - MCP å·¥å…·åŠ è½½

---

### 2. **`adk_llm_adapter.py`** - LLM é€‚é…å™¨ â­â­â­â­

**è§’è‰²**: å°†æˆ‘ä»¬çš„ LLM å®¢æˆ·ç«¯é€‚é…åˆ° ADK çš„ `BaseLlm` æ¥å£

**ä¸»è¦åŠŸèƒ½**:
- å®ç° ADK è¦æ±‚çš„ `generate_content_async()` æ–¹æ³•
- è½¬æ¢æ¶ˆæ¯æ ¼å¼ï¼šADK â†” Ollama/OpenAI
- å¤„ç†å·¥å…·è°ƒç”¨å’Œç»“æœ
- æµå¼å“åº”å¤„ç†

**å…³é”®æµç¨‹**:
```
ADK LlmRequest
    â†“
è½¬æ¢ä¸º Ollama æ ¼å¼
    â†“
è°ƒç”¨ our_client.chat()
    â†“
æµå¼æ¥æ”¶å“åº”
    â†“
è½¬æ¢ä¸º ADK LlmResponse
```

**è°ƒç”¨è€…**: `ADK Agent` (ç”± Google ADK æ¡†æ¶è°ƒç”¨)  
**ä¾èµ–**: `BaseAIClient` (Qwen/OpenAI å®¢æˆ·ç«¯)

---

### 3. **`adk_session_service.py`** - ä¼šè¯æœåŠ¡ â­â­â­

**è§’è‰²**: ä¸º ADK Runner æä¾›ä¼šè¯ç®¡ç†ï¼ˆSDK å±‚é¢è‡ªåŠ¨ç®¡ç†ï¼‰

**ä¸»è¦åŠŸèƒ½**:
- åˆ›å»ºã€è·å–ã€åˆ é™¤ä¼šè¯
- **è‡ªåŠ¨å­˜å‚¨**ä¼šè¯äº‹ä»¶ï¼ˆåŒ…æ‹¬ thinkingã€tool_callsã€tool_resultsï¼‰
- **è‡ªåŠ¨ä¼ é€’**å†å²ä¸Šä¸‹æ–‡ç»™ LLM
- å†…å­˜å­˜å‚¨ï¼ˆç®€åŒ–å®ç°ï¼‰

**å…³é”®ç±»**:
```python
class SimpleSessionService(BaseSessionService):
    async def create_session(app_name, user_id, session_id)
    async def get_session(app_name, user_id, session_id)
    async def delete_session(app_name, user_id, session_id)
```

**ä¸ºä»€ä¹ˆå¿…éœ€ï¼Ÿ**
è™½ç„¶ä»£ç çœ‹èµ·æ¥ç®€å•ï¼Œä½†è¿™æ˜¯ **ADK Runner çš„å¿…éœ€å‚æ•°**ã€‚ADK åœ¨ SDK å†…éƒ¨ä¼šï¼š
1. è‡ªåŠ¨è°ƒç”¨ SessionService å­˜å‚¨æ¯è½®å¯¹è¯çš„äº‹ä»¶
2. åœ¨å¤šè½®å¯¹è¯ä¸­è‡ªåŠ¨åŠ è½½å†å²äº‹ä»¶
3. ç»´æŠ¤å®Œæ•´çš„å¯¹è¯ä¸Šä¸‹æ–‡

**æµ‹è¯•éªŒè¯**ï¼ˆè§ `tests/test_adk_session.py`ï¼‰:
- âœ… ç¬¬ä¸€è½®å¯¹è¯åï¼Œä¼šè¯ä¸­è‡ªåŠ¨å­˜å‚¨äº† 592 ä¸ªäº‹ä»¶
- âœ… ç¬¬äºŒè½®å¯¹è¯æ—¶ï¼ŒLLM èƒ½å¤Ÿæ­£ç¡®è®°ä½ä¹‹å‰çš„å†…å®¹
- âœ… å·¥å…·è°ƒç”¨å†å²æ­£ç¡®ä¼ é€’ç»™ LLM
- âœ… å¤šè½®å¯¹è¯ä¸Šä¸‹æ–‡å®Œç¾ä¿æŒ

**è°ƒç”¨è€…**: `ADK Runner` (ADK æ¡†æ¶å†…éƒ¨è‡ªåŠ¨è°ƒç”¨)  
**ä¾èµ–**: æ— 

---

### 4. **`frontend_event_adapter.py`** - å‰ç«¯äº‹ä»¶è½¬æ¢å™¨ â­â­â­

**è§’è‰²**: å°† ADK äº‹ä»¶è½¬æ¢ä¸ºå‰ç«¯å±•ç¤ºæ ¼å¼

**ä¸»è¦åŠŸèƒ½**:
- æå–æ–‡æœ¬å†…å®¹ï¼ˆcontentï¼‰
- æå–æ€è€ƒå†…å®¹ï¼ˆthinkingï¼Œä» `<think>` æ ‡ç­¾ï¼‰
- æå–å·¥å…·è°ƒç”¨ï¼ˆtool_callï¼‰
- æå–å·¥å…·ç»“æœï¼ˆtool_resultï¼‰

**æ³¨æ„**: è¿™ä¸æ˜¯çœŸæ­£çš„ MCP åè®®ï¼ˆå·¥å…·è°ƒç”¨ï¼‰ï¼Œåªæ˜¯ç”¨äºå‰ç«¯å±•ç¤ºçš„æ ¼å¼è½¬æ¢

**å…³é”®æµç¨‹**:
```
ADK Event (Google æ ¼å¼)
    â†“
æå– content.parts
    â†“
æ£€æµ‹ <think> æ ‡ç­¾
    â†“
è¿”å›å‰ç«¯å±•ç¤ºæ ¼å¼çš„äº‹ä»¶å­—å…¸
```

**è°ƒç”¨è€…**: `ADKAgentAdapter`  
**ä¾èµ–**: MCP äº‹ä»¶æ ¼å¼å®šä¹‰ï¼ˆå¤ç”¨æ•°æ®ç»“æ„ï¼‰

---

### 5. **`mcp_tools_adapter.py`** - MCP å·¥å…·é€‚é…å™¨ â­â­â­â­

**è§’è‰²**: å°† MCP å·¥å…·è½¬æ¢ä¸º ADK FunctionTool

**ä¸»è¦åŠŸèƒ½**:
- ä¸ºä¼šè¯è®¾ç½® MCP å·¥å…·
- ä» MCP Client è·å–æ‰€æœ‰å·¥å…·
- ä¸ºæ¯ä¸ª MCP å·¥å…·åˆ›å»º ADK åŒ…è£…
- è‡ªåŠ¨ç”Ÿæˆå‡½æ•°ç­¾åå’Œæ–‡æ¡£

**å…³é”®å‡½æ•°**:
```python
async def setup_mcp_tools_for_session(session_id) -> MCPClient:
    # åˆ›å»º MCP å®¢æˆ·ç«¯
    # æ³¨å†Œæ‰€æœ‰å·¥å…·æœåŠ¡å™¨
    # è¿”å›é…ç½®å¥½çš„å®¢æˆ·ç«¯

async def create_mcp_tools_for_adk(mcp_client) -> List[FunctionTool]:
    # åˆ—å‡ºæ‰€æœ‰ MCP å·¥å…·
    # ä¸ºæ¯ä¸ªå·¥å…·åˆ›å»º ADK FunctionTool
    # è¿”å›å·¥å…·åˆ—è¡¨
```

**è°ƒç”¨è€…**: `ADKAgentAdapter`  
**ä¾èµ–**: `MCP Client`, `MCP Server`

---

### 6. **`factory.py`** - å®¢æˆ·ç«¯å·¥å‚ â­â­â­

**è§’è‰²**: åˆ›å»ºå’Œç®¡ç† LLM å®¢æˆ·ç«¯å®ä¾‹

**ä¸»è¦åŠŸèƒ½**:
- æ ¹æ® provider åˆ›å»ºå¯¹åº”å®¢æˆ·ç«¯
- å•ä¾‹æ¨¡å¼ï¼ˆåŒä¸€é…ç½®å¤ç”¨å®ä¾‹ï¼‰
- æ”¯æŒå¤šç§ LLM æä¾›å•†

**å…³é”®ç±»**:
```python
class AIFactory:
    def create_client(
        provider: str,     # "ollama", "openai" ç­‰
        model_name: str,   # æ¨¡å‹åç§°
        base_url: str      # API åœ°å€
    ) -> BaseAIClient
```

**è°ƒç”¨è€…**: `ChatService`, æµ‹è¯•ä»£ç   
**ä¾èµ–**: `BaseAIClient`, å„ä¸ªå…·ä½“å®¢æˆ·ç«¯

---

## ğŸ—ï¸ MCP æ¨¡å—ï¼ˆ`mcp/`ï¼‰

### 7. **`mcp/protocol.py`** - MCP åè®®å®šä¹‰ â­â­â­â­

**è§’è‰²**: å®šä¹‰ MCP æ ‡å‡†åè®®çš„æ‰€æœ‰æ•°æ®ç»“æ„

**ä¸»è¦å†…å®¹**:
- JSON-RPC 2.0 åŸºç¡€ç±»å‹
- å·¥å…·å®šä¹‰ï¼ˆToolDefinition, ToolCallRequest, ToolCallResultï¼‰
- èµ„æºå®šä¹‰ï¼ˆResource, ResourceContentï¼‰
- æç¤ºå®šä¹‰ï¼ˆPromptï¼‰
- åˆå§‹åŒ–å’Œèƒ½åŠ›å£°æ˜

**ç”¨é€”**: è¢«æ‰€æœ‰ MCP ç›¸å…³æ¨¡å—ä½¿ç”¨

---

### 8. **`mcp/server.py`** - MCP Server åŸºç±» â­â­â­â­

**è§’è‰²**: æä¾› MCP æœåŠ¡å™¨çš„æŠ½è±¡åŸºç±»

**ä¸»è¦åŠŸèƒ½**:
- å¤„ç† JSON-RPC è¯·æ±‚
- è·¯ç”±åˆ°å…·ä½“çš„å¤„ç†å™¨
- åˆå§‹åŒ–æ¡æ‰‹
- å·¥å…·åˆ—è¡¨å’Œè°ƒç”¨

**å…³é”®ç±»**:
```python
class MCPServer(ABC):
    async def handle_request(request_data) -> response_data
    
    @abstractmethod
    async def get_tools() -> List[ToolDefinition]
    
    @abstractmethod
    async def call_tool(name, arguments) -> ToolCallResult

class InProcessMCPServer(MCPServer):
    # è¿›ç¨‹å†…æœåŠ¡å™¨ï¼ˆå½“å‰ä½¿ç”¨ï¼‰

class StdioMCPServer(MCPServer):
    # æ ‡å‡†è¾“å…¥/è¾“å‡ºæœåŠ¡å™¨ï¼ˆç”¨äºå­è¿›ç¨‹ï¼‰
```

**å­ç±»**: `CalculatorMCPServer`, `WeatherMCPServer`, `SearchMCPServer`

---

### 9. **`mcp/client.py`** - MCP Client â­â­â­â­

**è§’è‰²**: MCP å®¢æˆ·ç«¯ï¼Œè´Ÿè´£ä¸ MCP æœåŠ¡å™¨é€šä¿¡

**ä¸»è¦åŠŸèƒ½**:
- æ³¨å†Œå’Œç®¡ç†å¤šä¸ª MCP æœåŠ¡å™¨
- è‡ªåŠ¨å‘ç°å·¥å…·
- è·¯ç”±å·¥å…·è°ƒç”¨åˆ°æ­£ç¡®çš„æœåŠ¡å™¨
- ä¼šè¯çº§å®¢æˆ·ç«¯æ± 

**å…³é”®ç±»**:
```python
class MCPClient:
    async def register_server(name, server)
    async def list_all_tools() -> Dict[server_name, tools]
    async def call_tool(tool_name, arguments) -> ToolCallResult

class MCPClientPool:
    def get_or_create_client(session_id) -> MCPClient
```

**è°ƒç”¨è€…**: `mcp_tools_adapter`  
**ä¾èµ–**: `MCP Server` å®ä¾‹

---

### 10. **`mcp/tools_server.py`** - å…·ä½“å·¥å…·æœåŠ¡å™¨ â­â­â­

**è§’è‰²**: å°†å…·ä½“å·¥å…·åŒ…è£…ä¸º MCP æœåŠ¡å™¨

**å®ç°çš„æœåŠ¡å™¨**:
- `CalculatorMCPServer` - è®¡ç®—å™¨
- `WeatherMCPServer` - å¤©æ°”æŸ¥è¯¢
- `SearchMCPServer` - ç½‘ç»œæœç´¢

**æ¯ä¸ªæœåŠ¡å™¨**:
```python
class CalculatorMCPServer(InProcessMCPServer):
    async def get_tools():
        # âœ… ä» BaseTool è‡ªåŠ¨æå–å‚æ•°æè¿°
        params = CalculatorTool.get_parameters()
        
        # æ„å»º MCP å·¥å…·å®šä¹‰
        properties = {}
        for param_name, param_info in params.items():
            properties[param_name] = {
                "type": "string",
                "description": param_info.description  # ä½¿ç”¨çœŸå®æè¿°
            }
        
        return [ToolDefinition(
            name="calculate",
            description=CalculatorTool.get_description(),
            inputSchema={"type": "object", "properties": properties}
        )]
    
    async def call_tool(name, arguments):
        # æ‰§è¡Œå·¥å…·
        result = await self.calculator.execute(...)
        return ToolCallResult(content=[...])
```

**ä¾èµ–**: `tools/general/` ä¸‹çš„å…·ä½“å·¥å…·å®ç°

---

## ğŸ“¦ æ”¯æŒæ¨¡å—

### 11. **`clients/base.py`** - å®¢æˆ·ç«¯åŸºç±»

**è§’è‰²**: å®šä¹‰æ‰€æœ‰ LLM å®¢æˆ·ç«¯çš„ç»Ÿä¸€æ¥å£

**å…³é”®æ–¹æ³•**:
```python
class BaseAIClient(ABC):
    @abstractmethod
    async def chat(messages, tools, stream) -> AsyncIterator
```

---

### 12. **`clients/qwen_client.py`** - Qwen å®¢æˆ·ç«¯

**è§’è‰²**: Ollama/Qwen çš„å…·ä½“å®ç°

**ä¸»è¦åŠŸèƒ½**:
- è°ƒç”¨ Ollama API
- å¤„ç†æµå¼å“åº”
- æ”¯æŒå·¥å…·è°ƒç”¨

---

### 13. **`tools/base.py`** - å·¥å…·åŸºç±»

**è§’è‰²**: å®šä¹‰æ‰€æœ‰å·¥å…·çš„ç»Ÿä¸€æ¥å£

**å…³é”®æ–¹æ³•**:
```python
class BaseTool(ABC):
    @abstractmethod
    async def execute(**kwargs) -> Any
    
    def get_name() -> str
    def get_description() -> str
```

---

### 14. **`tools/general/`** - é€šç”¨å·¥å…·

åŒ…å«å…·ä½“çš„å·¥å…·å®ç°ï¼š
- `calculator.py` - è®¡ç®—å™¨å·¥å…·
- `weather.py` - å¤©æ°”æŸ¥è¯¢å·¥å…·
- `search.py` - æœç´¢å·¥å…·

---

## ğŸ”„ å®Œæ•´è°ƒç”¨æµç¨‹å›¾

### 1ï¸âƒ£ **ç”¨æˆ·å‘é€æ¶ˆæ¯çš„å®Œæ•´æµç¨‹**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          ç”¨æˆ·å‘é€æ¶ˆæ¯                            â”‚
â”‚                    "åŒ—äº¬å¤©æ°”æ€ä¹ˆæ ·ï¼Ÿ"                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  1. ChatService (app/services/chat_service.py)                  â”‚
â”‚     - æ¥æ”¶ WebSocket æ¶ˆæ¯                                        â”‚
â”‚     - è·å–å†å²å¯¹è¯                                               â”‚
â”‚     - è°ƒç”¨ Agent                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  2. AIFactory.create_client()                                    â”‚
â”‚     â”œâ”€ åˆ›å»º QwenClient å®ä¾‹                                     â”‚
â”‚     â””â”€ è¿”å› BaseAIClient                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  3. ADKAgentAdapter.__init__()                                   â”‚
â”‚     â”œâ”€ åˆ›å»º ADKLlmAdapter(our_client)                           â”‚
â”‚     â”œâ”€ åˆ›å»º SimpleSessionService()                              â”‚
â”‚     â””â”€ åˆ›å»º FrontendEventAdapter()                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  4. ADKAgentAdapter.run_streaming()                              â”‚
â”‚                                                                   â”‚
â”‚     æ­¥éª¤ A: åŠ è½½å·¥å…·ï¼ˆé€šè¿‡ MCPï¼‰                                â”‚
â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚     â”‚ setup_mcp_tools_for_session(session_id)      â”‚           â”‚
â”‚     â”‚   â”œâ”€ è·å–/åˆ›å»º MCP Client                     â”‚           â”‚
â”‚     â”‚   â”œâ”€ åˆ›å»º Calculator MCP Server              â”‚           â”‚
â”‚     â”‚   â”œâ”€ åˆ›å»º Weather MCP Server                 â”‚           â”‚
â”‚     â”‚   â”œâ”€ åˆ›å»º Search MCP Server                  â”‚           â”‚
â”‚     â”‚   â””â”€ æ³¨å†Œæ‰€æœ‰æœåŠ¡å™¨åˆ°å®¢æˆ·ç«¯                  â”‚           â”‚
â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â”‚                         â”‚                                        â”‚
â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚     â”‚ create_mcp_tools_for_adk(mcp_client)         â”‚           â”‚
â”‚     â”‚   â”œâ”€ è°ƒç”¨ mcp_client.list_all_tools()        â”‚           â”‚
â”‚     â”‚   â”‚   â””â”€ æ¯ä¸ª Server è¿”å›å·¥å…·å®šä¹‰            â”‚           â”‚
â”‚     â”‚   â””â”€ ä¸ºæ¯ä¸ªå·¥å…·åˆ›å»º ADK FunctionTool         â”‚           â”‚
â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â”‚                         â”‚                                        â”‚
â”‚     æ­¥éª¤ B: åˆ›å»º ADK Agent å’Œ Runner                            â”‚
â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚     â”‚ Agent(model=adk_llm, tools=adk_tools)        â”‚           â”‚
â”‚     â”‚ Runner(agent=agent, session_service=...)     â”‚           â”‚
â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â”‚                         â”‚                                        â”‚
â”‚     æ­¥éª¤ C: è¿è¡Œ Runnerï¼ˆæµå¼ï¼‰                                 â”‚
â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚     â”‚ async for event in runner.run_async()        â”‚           â”‚
â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  5. ADK Runner è‡ªåŠ¨å¾ªç¯                                          â”‚
â”‚                                                                   â”‚
â”‚     [è½®æ¬¡ 1] LLM å†³ç­–                                            â”‚
â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚     â”‚ ADKLlmAdapter.generate_content_async()       â”‚           â”‚
â”‚     â”‚   â”œâ”€ è½¬æ¢ ADK Request â†’ Ollama æ ¼å¼         â”‚           â”‚
â”‚     â”‚   â”œâ”€ è°ƒç”¨ our_client.chat(stream=True)      â”‚           â”‚
â”‚     â”‚   â”œâ”€ QwenClient â†’ Ollama API                â”‚           â”‚
â”‚     â”‚   â””â”€ è¿”å›: tool_call(get_weather, "åŒ—äº¬")   â”‚           â”‚
â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â”‚                         â”‚                                        â”‚
â”‚     [è½®æ¬¡ 2] æ‰§è¡Œå·¥å…·                                            â”‚
â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚     â”‚ ADK è°ƒç”¨ FunctionTool.func()                 â”‚           â”‚
â”‚     â”‚   â”œâ”€ FunctionTool è°ƒç”¨ mcp_client.call_tool()â”‚           â”‚
â”‚     â”‚   â”œâ”€ MCP Client è·¯ç”±åˆ° Weather Server       â”‚           â”‚
â”‚     â”‚   â”œâ”€ Weather Server è°ƒç”¨ WeatherTool.execute()â”‚          â”‚
â”‚     â”‚   â””â”€ è¿”å›: {"temp": 25Â°C, "weather": "æ™´"}  â”‚           â”‚
â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â”‚                         â”‚                                        â”‚
â”‚     [è½®æ¬¡ 3] LLM ç”Ÿæˆæœ€ç»ˆå›ç­”                                    â”‚
â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚     â”‚ ADKLlmAdapter.generate_content_async()       â”‚           â”‚
â”‚     â”‚   â”œâ”€ å‘é€ç»™ LLMï¼ˆå¸¦ä¸Šå·¥å…·ç»“æœï¼‰              â”‚           â”‚
â”‚     â”‚   â””â”€ è¿”å›: "åŒ—äº¬ä»Šå¤©25Â°Cï¼Œå¤©æ°”æ™´æœ—..."       â”‚           â”‚
â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  6. FrontendEventAdapter.convert_adk_event_stream()              â”‚
â”‚     â”œâ”€ æå–æ–‡æœ¬å†…å®¹                                             â”‚
â”‚     â”œâ”€ æå– <think> æ ‡ç­¾ï¼ˆå¦‚æœæœ‰ï¼‰                              â”‚
â”‚     â”œâ”€ æå–å·¥å…·è°ƒç”¨                                             â”‚
â”‚     â”œâ”€ æå–å·¥å…·ç»“æœ                                             â”‚
â”‚     â””â”€ è½¬æ¢ä¸ºå‰ç«¯å±•ç¤ºæ ¼å¼                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  7. ADKAgentAdapter._frontend_to_chat_format()                   â”‚
â”‚     â””â”€ æœ€åä¸€å±‚æ ¼å¼è½¬æ¢ï¼ˆå‰ç«¯æ ¼å¼ â†’ ChatService æ ¼å¼ï¼‰          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  8. ChatService æ¥æ”¶æµå¼äº‹ä»¶                                     â”‚
â”‚     â”œâ”€ {type: "content", content: "åŒ—äº¬ä»Šå¤©..."}                â”‚
â”‚     â”œâ”€ {type: "tool_call", tool_name: "get_weather", ...}       â”‚
â”‚     â”œâ”€ {type: "tool_result", result: {...}}                     â”‚
â”‚     â””â”€ é€šè¿‡ WebSocket å‘é€ç»™å‰ç«¯                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ¨ æ¨¡å—å…³ç³»å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        AI æ¨¡å—æ¶æ„                               â”‚
â”‚                                                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚              ADKAgentAdapter (æ ¸å¿ƒ)                     â”‚     â”‚
â”‚  â”‚          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚     â”‚
â”‚  â”‚          â”‚          â”‚          â”‚          â”‚            â”‚     â”‚
â”‚  â”‚          â–¼          â–¼          â–¼          â–¼            â”‚     â”‚
â”‚  â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚     â”‚
â”‚  â”‚   â”‚   LLM    â”‚ â”‚Session â”‚ â”‚  MCP   â”‚ â”‚   MCP    â”‚    â”‚     â”‚
â”‚  â”‚   â”‚ Adapter  â”‚ â”‚Service â”‚ â”‚Frontendâ”‚ â”‚  Tools   â”‚    â”‚     â”‚
â”‚  â”‚   â”‚          â”‚ â”‚        â”‚ â”‚ Event  â”‚ â”‚  Adapter â”‚    â”‚     â”‚
â”‚  â”‚   â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜    â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚            â”‚                                   â”‚                â”‚
â”‚            â–¼                                   â–¼                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚   LLM Clients    â”‚              â”‚   MCP System     â”‚        â”‚
â”‚  â”‚                  â”‚              â”‚                  â”‚        â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚              â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚        â”‚
â”‚  â”‚  â”‚  Factory   â”‚  â”‚              â”‚  â”‚   Client   â”‚ â”‚        â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â”‚              â”‚  â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜ â”‚        â”‚
â”‚  â”‚        â”‚         â”‚              â”‚        â”‚        â”‚        â”‚
â”‚  â”‚        â–¼         â”‚              â”‚        â–¼        â”‚        â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚              â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚        â”‚
â”‚  â”‚  â”‚QwenClient  â”‚  â”‚              â”‚  â”‚  Servers   â”‚ â”‚        â”‚
â”‚  â”‚  â”‚(Ollama)    â”‚  â”‚              â”‚  â”‚            â”‚ â”‚        â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚              â”‚  â”‚Calculator  â”‚ â”‚        â”‚
â”‚  â”‚                  â”‚              â”‚  â”‚Weather     â”‚ â”‚        â”‚
â”‚  â”‚  BaseAIClient    â”‚              â”‚  â”‚Search      â”‚ â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚  â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜ â”‚        â”‚
â”‚                                    â”‚        â”‚        â”‚        â”‚
â”‚                                    â”‚        â–¼        â”‚        â”‚
â”‚                                    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚        â”‚
â”‚                                    â”‚  â”‚   Tools    â”‚ â”‚        â”‚
â”‚                                    â”‚  â”‚(å®é™…å®ç°)   â”‚ â”‚        â”‚
â”‚                                    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚        â”‚
â”‚                                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“ å…³é”®æ•°æ®æµ

### å·¥å…·è°ƒç”¨çš„ä¸¤æ¡è·¯å¾„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      å·¥å…·ç»“æœçš„ä¸¤æ¡è·¯å¾„                          â”‚
â”‚                                                                   â”‚
â”‚  ADK æ‰§è¡Œå·¥å…· â†’ å¾—åˆ°ç»“æœ                                         â”‚
â”‚        â”‚                                                          â”‚
â”‚        â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”‚
â”‚        â”‚                  â”‚                  â”‚                   â”‚
â”‚        â–¼                  â–¼                  â–¼                   â”‚
â”‚   è·¯å¾„ 1: ä¼ ç»™ LLM    è·¯å¾„ 2: ä¼ ç»™å‰ç«¯                           â”‚
â”‚   (å†…éƒ¨å¾ªç¯)          (äº‹ä»¶æµ)                                   â”‚
â”‚        â”‚                  â”‚                                      â”‚
â”‚        â–¼                  â–¼                                      â”‚
â”‚  ADKLlmAdapter      FrontendEventAdapter                         â”‚
â”‚  (ä¸ç»è¿‡ MCP)       (è½¬æ¢ä¸ºå±•ç¤ºæ ¼å¼)                             â”‚
â”‚        â”‚                  â”‚                                      â”‚
â”‚        â–¼                  â–¼                                      â”‚
â”‚  {"role": "tool",   {"type": "tool_result",                     â”‚
â”‚   "content": ...}    "result": ...}                             â”‚
â”‚        â”‚                  â”‚                                      â”‚
â”‚        â–¼                  â–¼                                      â”‚
â”‚  å‘é€ç»™ Ollama      å‘é€ç»™å‰ç«¯                                   â”‚
â”‚  (ä¸‹ä¸€è½®å¯¹è¯)       (å®æ—¶å±•ç¤º)                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”‘ å…³é”®è®¾è®¡æ¨¡å¼

### 1. **é€‚é…å™¨æ¨¡å¼** (Adapter Pattern)

```
å¤–éƒ¨æ¥å£ â†’ é€‚é…å™¨ â†’ å†…éƒ¨å®ç°

ä¾‹å¦‚ï¼š
ChatService â†’ ADKAgentAdapter â†’ ADK Agent
BaseAIClient â†’ ADKLlmAdapter â†’ ADK BaseLlm
BaseTool â†’ CalculatorMCPServer â†’ MCP Server
```

### 2. **å·¥å‚æ¨¡å¼** (Factory Pattern)

```
AIFactory.create_client(provider, model_name)
  â”œâ”€ "ollama" â†’ QwenClient
  â”œâ”€ "openai" â†’ OpenAIClient
  â””â”€ "anthropic" â†’ AnthropicClient (æœªæ¥)
```

### 3. **ç­–ç•¥æ¨¡å¼** (Strategy Pattern)

```
ä¸åŒçš„ LLM å®¢æˆ·ç«¯å®ç°ç›¸åŒæ¥å£
  â”œâ”€ BaseAIClient (æŠ½è±¡åŸºç±»)
  â”œâ”€ QwenClient (Ollama å®ç°)
  â””â”€ OpenAIClient (OpenAI å®ç°)
```

### 4. **è§‚å¯Ÿè€…æ¨¡å¼** (Observer Pattern)

```
æµå¼å“åº”ï¼ˆAsyncIteratorï¼‰
  â””â”€ æ¯ä¸ªäº‹ä»¶é€šçŸ¥è®¢é˜…è€…ï¼ˆChatServiceï¼‰
```

---

## ğŸ’¡ è®¾è®¡äº®ç‚¹

### 1. **è§£è€¦ä¸æ ‡å‡†åŒ–**
- é€šè¿‡ MCP åè®®è§£è€¦å·¥å…·å®ç°
- é€šè¿‡é€‚é…å™¨è§£è€¦å¤–éƒ¨æ¡†æ¶ï¼ˆADKï¼‰
- ç¬¦åˆè¡Œä¸šæ ‡å‡†ï¼ˆMCP, JSON-RPCï¼‰

### 2. **å¯æ‰©å±•æ€§**
- æ–°å¢ LLM åªéœ€å®ç° `BaseAIClient`
- æ–°å¢å·¥å…·åªéœ€åˆ›å»º `MCPServer`
- æ”¯æŒå¤–éƒ¨ MCP æœåŠ¡å™¨

### 3. **æµå¼å¤„ç†**
- æ‰€æœ‰æ ¸å¿ƒæµç¨‹æ”¯æŒæµå¼
- å®æ—¶å“åº”ï¼Œç”¨æˆ·ä½“éªŒå¥½
- èµ„æºåˆ©ç”¨ç‡é«˜

### 4. **ä¼šè¯éš”ç¦»**
- æ¯ä¸ªä¼šè¯ç‹¬ç«‹çš„ MCP Client
- ä¼šè¯çº§å·¥å…·çŠ¶æ€ç®¡ç†
- é¿å…è·¨ä¼šè¯å¹²æ‰°

---

## ğŸ“– ä½¿ç”¨ç¤ºä¾‹

### åŸºæœ¬ç”¨æ³•

```python
# 1. åˆ›å»ºå®¢æˆ·ç«¯
from app.ai.factory import FACTORY
client = FACTORY.create_client("ollama", "qwen3:8b")

# 2. åˆ›å»º Agent
from app.ai.adk_agent_adapter import ADKAgentAdapter
agent = ADKAgentAdapter(client)

# 3. è¿è¡Œï¼ˆå·¥å…·è‡ªåŠ¨é€šè¿‡ MCP åŠ è½½ï¼‰
async for event in agent.run_streaming(
    messages=[{"role": "user", "content": "è®¡ç®— 2+2"}],
    session_id="session_123"
):
    print(event)
    # {"type": "tool_call", "tool_name": "calculate", ...}
    # {"type": "tool_result", "result": {"result": 4}}
    # {"type": "content", "content": "2+2ç­‰äº4"}
```

---

## ğŸš€ æœªæ¥æ‰©å±•

1. **å¤–éƒ¨ MCP Server æ”¯æŒ**
   - Stdio é€šä¿¡
   - WebSocket è¿œç¨‹è¿æ¥

2. **æ›´å¤š LLM æ”¯æŒ**
   - Anthropic Claude
   - Google Gemini
   - æœ¬åœ°æ¨¡å‹

3. **MCP åŠŸèƒ½æ‰©å±•**
   - Resourcesï¼ˆèµ„æºè®¿é—®ï¼‰
   - Promptsï¼ˆæç¤ºæ¨¡æ¿ï¼‰

4. **æ€§èƒ½ä¼˜åŒ–**
   - å·¥å…·ç»“æœç¼“å­˜
   - å¹¶è¡Œå·¥å…·è°ƒç”¨
   - è¿æ¥æ± ç®¡ç†

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- `mcp/README.md` - MCP è¯¦ç»†æ–‡æ¡£
- `MCP_IMPLEMENTATION_COMPLETE.md` - MCP å®ç°æŠ¥å‘Š
- `CLEANUP_SUMMARY.md` - ä»£ç æ¸…ç†æ€»ç»“

---

**è¿™ä»½æ–‡æ¡£å±•ç¤ºäº† AI æ¨¡å—çš„å®Œæ•´æ¶æ„å’Œåä½œå…³ç³»ï¼** ğŸ‰

